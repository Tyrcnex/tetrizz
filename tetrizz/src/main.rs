use utils::{
    data::Piece,
    game::Game,
    queue::extend_queue
};
use tetrizz::{
    eval::{
        base::MinimalEval,
        feature0::FeatureNonLinearEval
    },
    battle::{Battle, Player}
};

fn main() {
    let mut queue0: Vec<Piece> = vec![];
    let mut queue1: Vec<Piece> = vec![];
    extend_queue(&mut queue0, 5);
    extend_queue(&mut queue1, 5);
    let mut battle = Battle {
        player0: Player {
            game: Game::new_empty(),
            queue: vec![],
            // eval: MinimalEval { values: [181.895492184286, -399.93570994040635, 381.4761690885799, -419.33154332619665, -83.48157030036961, -161.95787724878292, -116.73024914147564, -138.5506890753284, -388.288092562069, -240.1590094390449, -2.9401061494848495, -409.0500339178186, -207.62545452919613, 26.415515422135027] }
            eval: FeatureNonLinearEval::from_array(&[-0.990385101, -0.143788024, -0.256912868, -0.753156664, -0.883179114, 0.878593800, 0.487103042, 0.446904921, -0.022053485, 0.480680119, -0.427992668, -0.067247363, -1.021378474, 0.791463362, -0.337951793, 0.529580796, 0.444598401, -0.623214760, -0.591721728, -0.270067905, -0.733569684, -0.798552555, -0.412567480, -0.258917586, -0.548967261, 0.696959302, -0.303210560, -0.673181149, -0.712236661, 1.040082993, -0.315905307, -0.780773189, -0.527572296, -1.127759543, -0.961013334, 0.915498884, -0.852197173, 0.323220254, 0.760665261, -1.025931884, 0.173724612, -0.318301899, 1.027925275, -0.826695841, 0.003642873, 1.074162592, -0.767295947, 0.734040955, 0.649320421, 0.412493622, -0.468254555, -0.356955609, -0.549032409, -0.506339922, -0.136707478, 0.969250419, 0.950200099, -1.252394149, 0.443599395, 0.486686045, 0.329398179, -0.669532545, -0.121505108, 0.874095605, 0.660067080, 0.150487289, 0.287725403, 0.538710881, 1.049013655, -0.072491760, 1.026091330, -0.968556963, -0.212303999, -0.836900611, 0.142643572, -0.472527185, -0.113109903, 0.541119795, -0.979282945, -0.014936526, -0.055539985, -0.218362268, 0.407442057, 0.489922234, -0.933515639, -0.330810669, 0.742212640, -0.264436450, 0.293553694, 0.008958688, 0.025583843, -0.018885086, -0.100377872, -0.302734666, -1.056756527, 0.169328084, -0.799367198, 0.607216842, 0.458940789, -0.448663611, 0.830503480, 0.072181222, -0.509125806, -0.898795539, -0.220874241, -0.126992579, 0.014924797, -0.139169893, 0.691724392, -0.000061450, 0.559908980, 0.219595721, 0.608402123, 0.351231396, -0.851038805, 0.131920695, -0.785671194, 0.302619690, 0.898024646, 0.012467017, -0.098223885, 0.832662782, 0.834298298, 0.415481107, -0.435020864, 0.668728735, -0.803930723, -0.799679888, 0.746819461, 0.813742204, -0.580766348, 0.177803057, 0.741291071, -0.887910331, 0.566857757, -0.643724849, -0.816003965, -0.825711662, -0.664011903, 0.603242569, -0.511154452, 0.695125222, -0.686326321, -0.463043460, -0.276286597, -0.313398672, -0.051366784, 0.527071705, -0.079337268, 0.819343567, 0.091986522, -0.383165121, 0.756066524, 0.222976378, 0.694749358, -0.054402342, 0.120308901, -0.954615294, -0.646426337, -0.502558543, 0.067681063, 0.262952249, 0.910735674, 0.844259244, -0.016794493, 0.318704960, 0.681401800, -0.532686910, -0.990511223, -0.514788358, 0.651136899, -0.830374433, -0.316394368, -0.106195913, -0.838993235, 0.564542651, 0.578998870, -0.234944047, -0.764318204, -0.768763831, 0.358934848, 0.746392069, -0.803876967, -0.934037339, 0.065391908, 0.097074441, -0.683980667, -0.274355974, 0.447821045, 0.625441826, -0.333275443, -0.278789840, -0.299514704, 0.429196262, 0.785765412, 0.322367362, -0.017788457, 1.293779995, -0.459982797, -0.223478232])
        },
        player1: Player {
            game: Game::new_empty(),
            queue: vec![],
            eval: MinimalEval { values: [-0.3335903388433292, -0.25750971325030974, -0.05115233297009883, -0.3067533752401169, -0.1854127319664896, -0.1070342999530273, -0.3690213829655287, 0.09663015564572557, -0.4766250155906852, -0.05872828521759004, 1.06812123537880416, -1.0169857268318688, -0.4575993254187147, 2.28085733274743393, 0.002] }
        },
        who: 0
    };

    loop {
        if queue0.len() <= 14 { extend_queue(&mut queue0, 1); }
        if queue1.len() <= 14 { extend_queue(&mut queue1, 1); }
        let oldgame0 = battle.player0.game.clone();
        let oldgame1 = battle.player1.game.clone();
        battle.player0.queue = queue0[..7].iter().copied().collect();
        battle.player1.queue = queue1[..7].iter().copied().collect();
        let who = battle.who;
        let result = battle.advance();
        if result.is_none() { break; }

        if who == 0 { queue0.remove(0); } else { queue1.remove(0); }
        
        let str0 = oldgame0.into_string(if who == 0 { result.as_ref() } else { None });
        let str1 = oldgame1.into_string(if who == 1 { result.as_ref() } else { None });
        let lines0: Vec<&str> = str0.lines().collect();
        let lines1: Vec<&str> = str1.lines().collect();
        println!("\n\n\n");
        for (line0, line1) in lines0.into_iter().zip(lines1.into_iter()) {
            println!("{}    {}", line0, line1);
        }
    }
    println!("{}", battle.who);
}