{"version":3,"sources":["../../src/engine/index.ts"],"sourcesContent":["import type { Game } from \"../types/game\";\nimport { EventEmitter } from \"../utils/events\";\nimport { Board, type BoardInitializeParams, ConnectedBoard } from \"./board\";\nimport { constants } from \"./constants\";\nimport { GarbageQueue, type GarbageQueueInitializeParams, type IncomingGarbage, LegacyGarbageQueue, type OutgoingGarbage } from \"./garbage\";\nimport { IGEHandler, type MultiplayerOptions } from \"./multiplayer\";\nimport { Queue, type QueueInitializeParams } from \"./queue\";\nimport { Mino } from \"./queue/types\";\nimport type { EngineSnapshot, Events, IncreasableValue, LockRes, SpinType } from \"./types\";\nimport { IncreaseTracker, deepCopy } from \"./utils\";\nimport { garbageCalcV2, garbageData } from \"./utils/damageCalc\";\nimport { type KickTable, legal, performKick } from \"./utils/kicks\";\nimport { type KickTableName, cornerTable, kicks, spinbonusRules } from \"./utils/kicks/data\";\nimport { Tetromino, tetrominoes } from \"./utils/tetromino\";\nimport type { Rotation } from \"./utils/tetromino/types\";\n\n\n\nimport chalk from \"chalk\";\n\n\nexport interface GameOptions {\n  spinBonuses: Game.SpinBonuses;\n  comboTable: keyof (typeof garbageData)[\"comboTable\"] | \"multiplier\";\n  garbageTargetBonus: \"none\" | \"normal\" | string;\n  clutch: boolean;\n  garbageBlocking: \"combo blocking\" | \"limited blocking\" | \"none\";\n}\n\nexport type PCOptions =\n  | false\n  | {\n      garbage: number;\n      b2b: number;\n    };\n\nexport interface B2BOptions {\n  chaining: boolean;\n  charging:\n    | false\n    | {\n        at: number;\n        base: number;\n      };\n}\n\nexport interface MiscellaneousOptions {\n  movement: {\n    infinite: boolean;\n    lockResets: number;\n    lockTime: number;\n    may20G: boolean;\n  };\n  allowed: {\n    spin180: boolean;\n    hardDrop: boolean;\n    hold: boolean;\n  };\n  infiniteHold: boolean;\n  username?: string;\n  date?: Date;\n}\n\nexport interface EngineInitializeParams {\n  queue: QueueInitializeParams;\n  board: BoardInitializeParams;\n  kickTable: KickTable;\n  options: GameOptions;\n  gravity: IncreasableValue;\n  garbage: GarbageQueueInitializeParams;\n  handling: Game.Handling;\n  pc: PCOptions;\n  b2b: B2BOptions;\n  multiplayer?: MultiplayerOptions;\n  misc: MiscellaneousOptions;\n}\n\nexport class Engine {\n  queue!: Queue;\n  held!: Mino | null;\n  holdLocked!: boolean;\n  falling!: Tetromino;\n  private _kickTable!: KickTableName;\n  board!: Board;\n  connectedBoard!: ConnectedBoard;\n  lastSpin!: {\n    piece: Mino;\n    type: SpinType;\n  } | null;\n  lastWasClear!: boolean;\n  stats!: {\n    garbage: {\n      sent: number;\n      attack: number;\n      receive: number;\n      cleared: number;\n    };\n    combo: number;\n    b2b: number;\n    pieces: number;\n    lines: number;\n  };\n  gameOptions!: GameOptions;\n  garbageQueue!: GarbageQueue | LegacyGarbageQueue;\n\n  frame!: number;\n  subframe!: number;\n\n  initializer: EngineInitializeParams;\n\n  handling!: Game.Handling;\n\n  input!: {\n    lShift: { held: boolean; arr: number; das: number; dir: -1 };\n    rShift: { held: boolean; arr: number; das: number; dir: 1 };\n    lastShift: number;\n    keys: {\n      [k in\n        | \"softDrop\"\n        | \"rotateCCW\"\n        | \"rotateCW\"\n        | \"rotate180\"\n        | \"hold\"]: boolean;\n    };\n    firstInputTime: number;\n    time: {\n      start: number;\n      zero: boolean;\n      locked: boolean;\n      prev: number;\n      frameoffset: number;\n    };\n    lastPieceTime: number;\n  };\n\n  pc!: PCOptions;\n  b2b!: B2BOptions;\n\n  dynamic!: {\n    gravity: IncreaseTracker;\n    garbageMultiplier: IncreaseTracker;\n    garbageCap: IncreaseTracker;\n  };\n\n  glock!: number;\n\n  multiplayer?: {\n    options: MultiplayerOptions;\n    targets: number[];\n    passthrough: {\n      network: boolean;\n      replay: boolean;\n      travel: boolean;\n    };\n  };\n  igeHandler!: IGEHandler;\n\n  misc!: MiscellaneousOptions;\n\n  state!: number;\n\n  currentSpike!: number;\n\n  events = new EventEmitter<Events>();\n\n  private resCache!: {\n    pieces: number;\n    garbage: {\n      sent: number[];\n      received: OutgoingGarbage[];\n    };\n    keys: Game.Key[];\n    lastLock: number;\n  };\n\n  constructor(options: EngineInitializeParams) {\n    this.initializer = deepCopy(options, [\n      { type: Date, copy: (d) => new Date(d) }\n    ]);\n\n    this.init();\n  }\n\n  init() {\n    const options = deepCopy(this.initializer, [\n      { type: Date, copy: (d) => new Date(d) }\n    ]);\n\n    this.queue = new Queue(options.queue);\n\n    this.queue.onRepopulate(this.#onQueueRepopulate.bind(this));\n\n    this._kickTable = options.kickTable;\n\n    this.board = new Board(options.board);\n    this.connectedBoard = new ConnectedBoard(options.board);\n\n    this.garbageQueue = new (\n      (options.misc.date ?? new Date()) > new Date(\"2025-05-06T15:00:00-04:00\")\n        ? GarbageQueue\n        : LegacyGarbageQueue\n    )(options.garbage);\n\n    this.igeHandler = new IGEHandler(options.multiplayer?.opponents || []);\n\n    if (options.multiplayer)\n      this.multiplayer = {\n        options: options.multiplayer,\n        targets: [],\n        passthrough: {\n          network: [\"consistent\", \"zero\"].includes(\n            options.multiplayer.passthrough\n          ),\n          replay: options.multiplayer.passthrough !== \"full\",\n          travel: [\"zero\", \"limited\"].includes(options.multiplayer.passthrough)\n        }\n      };\n\n    this.held = null;\n    this.holdLocked = false;\n    this.lastSpin = null;\n    this.lastWasClear = false;\n\n    this.stats = {\n      combo: -1,\n      b2b: -1,\n      pieces: 0,\n      lines: 0,\n      garbage: {\n        sent: 0,\n        attack: 0,\n        receive: 0,\n        cleared: 0\n      }\n    };\n\n    this.pc = options.pc;\n    this.b2b = {\n      chaining: options.b2b.chaining,\n      charging: options.b2b.charging\n    };\n\n    this.dynamic = {\n      gravity: new IncreaseTracker(\n        options.gravity.value,\n        options.gravity.increase,\n        options.gravity.marginTime\n      ),\n      garbageMultiplier: new IncreaseTracker(\n        options.garbage.multiplier.value,\n        options.garbage.multiplier.increase,\n        options.garbage.multiplier.marginTime\n      ),\n      garbageCap: new IncreaseTracker(\n        options.garbage.cap.value,\n        options.garbage.cap.increase,\n        options.garbage.cap.marginTime\n      )\n    };\n\n    this.glock = 0;\n\n    this.misc = options.misc;\n\n    this.gameOptions = options.options;\n    this.handling = options.handling;\n    this.input = {\n      lShift: { held: false, arr: 0, das: 0, dir: -1 },\n      rShift: { held: false, arr: 0, das: 0, dir: 1 },\n      lastShift: -1,\n      firstInputTime: -1,\n      time: { start: 0, zero: true, locked: false, prev: 0, frameoffset: 0 },\n      lastPieceTime: 0,\n      keys: {\n        softDrop: false,\n        hold: false,\n        rotateCW: false,\n        rotateCCW: false,\n        rotate180: false\n      }\n    };\n    this.frame = 0;\n    this.subframe = 0;\n\n    this.state = 0;\n\n    this.currentSpike = 0;\n\n    this.flushRes();\n\n    this.nextPiece();\n\n    this.bindAll();\n  }\n\n  private flushRes() {\n    const res = this.resCache ? deepCopy(this.resCache) : null;\n    this.resCache = {\n      pieces: 0,\n      garbage: {\n        sent: [],\n        received: []\n      },\n      keys: [],\n      lastLock: res?.lastLock ?? 0\n    };\n\n    return res!;\n  }\n\n  reset() {\n    this.init();\n  }\n\n  bindAll() {\n    this.moveRight = this.moveRight.bind(this);\n    this.moveLeft = this.moveLeft.bind(this);\n    this.dasRight = this.dasRight.bind(this);\n    this.dasLeft = this.dasLeft.bind(this);\n    this.softDrop = this.softDrop.bind(this);\n    this.hardDrop = this.hardDrop.bind(this);\n    this.hold = this.hold.bind(this);\n    this.rotateCW = this.rotateCW.bind(this);\n    this.rotateCCW = this.rotateCCW.bind(this);\n    this.rotate180 = this.rotate180.bind(this);\n    this.snapshot = this.snapshot.bind(this);\n    this.fromSnapshot = this.fromSnapshot.bind(this);\n    this.nextPiece = this.nextPiece.bind(this);\n  }\n\n  #onQueueRepopulate(pieces: Mino[]) {\n    this.events.emit(\"queue.add\", pieces);\n  }\n\n  snapshot(): EngineSnapshot {\n    return {\n      board: deepCopy(this.board.state),\n      connectedBoard: deepCopy(this.connectedBoard.state),\n      falling: this.falling.snapshot(),\n      frame: this.frame,\n      garbage: this.garbageQueue.snapshot(),\n      hold: this.held,\n      holdLocked: this.holdLocked,\n      lastSpin: deepCopy(this.lastSpin),\n      lastWasClear: this.lastWasClear,\n      queue: this.queue.index,\n      input: deepCopy(this.input),\n      subframe: this.subframe,\n      targets: this.multiplayer?.targets,\n      stats: deepCopy(this.stats),\n      glock: this.glock,\n      ige: this.igeHandler.snapshot(),\n      state: this.state,\n      currentSpike: this.currentSpike,\n      resCache: deepCopy(this.resCache)\n    };\n  }\n\n  fromSnapshot(snapshot: EngineSnapshot) {\n\t\tconst options = deepCopy(this.initializer, [\n      { type: Date, copy: (d) => new Date(d) }\n    ]);\n    this.board.state = deepCopy(snapshot.board);\n    this.connectedBoard.state = deepCopy(snapshot.connectedBoard);\n    this.falling = new Tetromino({\n      boardHeight: this.board.height,\n      boardWidth: this.board.width,\n      initialRotation:\n        this.kickTable.spawn_rotation[\n          snapshot.falling.symbol.toLowerCase() as keyof typeof this.kickTable.spawn_rotation\n        ] ?? 0,\n      symbol: snapshot.falling.symbol,\n      from: snapshot.falling\n    });\n    for (const key of Object.keys(snapshot.falling)) {\n      // @ts-expect-error\n      this.falling[key] = deepCopy(snapshot.falling[key]);\n    }\n    this.frame = snapshot.frame;\n    this.subframe = snapshot.subframe;\n    this.garbageQueue.fromSnapshot(snapshot.garbage);\n    this.held = snapshot.hold;\n    this.holdLocked = snapshot.holdLocked;\n    this.lastSpin = deepCopy(snapshot.lastSpin);\n    this.lastWasClear = snapshot.lastWasClear;\n    this.queue = new Queue(options.queue);\n    for (let i = 0; i < snapshot.queue; i++) this.queue.shift();\n\n    this.queue.onRepopulate(this.#onQueueRepopulate.bind(this));\n\n    this.dynamic = {\n      gravity: new IncreaseTracker(\n        options.gravity.value,\n        options.gravity.increase,\n        options.gravity.marginTime\n      ),\n      garbageMultiplier: new IncreaseTracker(\n        options.garbage.multiplier.value,\n        options.garbage.multiplier.increase,\n        options.garbage.multiplier.marginTime\n      ),\n      garbageCap: new IncreaseTracker(\n        options.garbage.cap.value,\n        options.garbage.cap.increase,\n        options.garbage.cap.marginTime\n      )\n    };\n\n    for (let i = 0; i < this.frame; i++)\n      for (const key of Object.keys(this.dynamic))\n        this.dynamic[key as keyof typeof this.dynamic].tick();\n\n    this.input = deepCopy(snapshot.input);\n\n    if (this.multiplayer && snapshot.targets)\n      this.multiplayer.targets = [...snapshot.targets];\n\n    this.stats = deepCopy(snapshot.stats);\n    this.glock = snapshot.glock;\n    this.state = snapshot.state;\n    this.currentSpike = snapshot.currentSpike;\n    this.igeHandler.fromSnapshot(snapshot.ige);\n\n    this.resCache = deepCopy(snapshot.resCache);\n  }\n\n  get kickTable(): (typeof kicks)[KickTableName] {\n    return kicks[this._kickTable];\n  }\n\n  get kickTableName(): KickTableName {\n    return this._kickTable;\n  }\n\n  set kickTable(value: KickTableName) {\n    this._kickTable = value;\n  }\n\n  get dynamicStats() {\n    return {\n      apm: this.stats.garbage.attack / (this.frame / 60 / 60) || 0,\n      pps: this.stats.pieces / (this.frame / 60) || 0,\n      vs:\n        ((this.stats.garbage.attack + this.stats.garbage.cleared) /\n          (this.frame / 60)) *\n          100 || 0,\n      surgePower: this.b2b.charging\n        ? Math.floor(\n            this.stats.b2b - this.b2b.charging.at + this.b2b.charging.base + 1\n          )\n        : 0\n    };\n  }\n\n  #getEffectiveGravity() {\n    return this.glock <= 0\n      ? this.dynamic.gravity.get()\n      : this.glock <= 180\n        ? (1 - this.glock / 180) ** 2 * this.dynamic.gravity.get()\n        : 0;\n  }\n\n  #hasHitWall() {\n    return !!(this.state & constants.flags.STATE_WALL);\n  }\n\n  // @ts-expect-error unused\n  #hasRotated() {\n    return !!(\n      this.state &\n      (constants.flags.ROTATION_LEFT | constants.flags.ROTATION_RIGHT)\n    );\n  }\n\n  // @ts-expect-error unused\n  #hasRotated180() {\n    return !!(this.state & constants.flags.ROTATION_180);\n  }\n\n  // @ts-expect-error unused\n  #isSpin() {\n    return !!(this.state & constants.flags.ROTATION_SPIN);\n  }\n\n  // @ts-expect-error unused\n  #isSpinMini() {\n    return !(\n      ~this.state &\n      (constants.flags.ROTATION_SPIN | constants.flags.ROTATION_MINI)\n    );\n  }\n\n  // @ts-expect-error unused\n  #isSpinAll() {\n    return !!(this.state & constants.flags.ROTATION_SPIN_ALL);\n  }\n\n  #isSleep() {\n    return !!(this.state & constants.flags.STATE_SLEEP);\n  }\n\n  // @ts-expect-error unused\n  #isFloored() {\n    return !!(this.state & constants.flags.STATE_FLOOR);\n  }\n\n  // @ts-expect-error unused\n  #isVisible() {\n    return !(this.state & constants.flags.STATE_NODRAW);\n  }\n\n  // @ts-expect-error unused\n  #isSoftDropped() {\n    return !!(this.state & constants.flags.ACTION_SOFTDROP);\n  }\n\n  #isForcedToLock() {\n    return !!(this.state & constants.flags.ACTION_FORCELOCK);\n  }\n\n  #is20G() {\n    const is20G = this.dynamic.gravity.get() > this.board.height;\n    const mode20G = this.misc.movement.may20G;\n\n    if (this.input.keys.softDrop) {\n      const preferSoftDrop = this.handling.may20g || (is20G && mode20G);\n      return (\n        (this.handling.sdf === 41 ||\n          this.dynamic.gravity.get() * this.handling.sdf > this.board.height) &&\n        preferSoftDrop\n      );\n    }\n\n    return is20G && mode20G;\n  }\n\n  #shouldLock() {\n    return (\n      !this.misc.movement.infinite &&\n      this.falling.lockResets >= this.misc.movement.lockResets\n    );\n  }\n\n  #shouldFallFaster() {\n    return this.misc.movement.infinite\n      ? false\n      : this.falling.rotResets > this.misc.movement.lockResets + 15;\n  }\n\n  #clearFlags(e: number) {\n    this.state &= ~e;\n  }\n\n  #__internal_lock(subframe = 1 - this.subframe) {\n    this.falling.locking += subframe;\n    return (\n      this.falling.locking > this.misc.movement.lockTime ||\n      !!this.#isForcedToLock() ||\n      this.#shouldLock()\n    );\n  }\n\n  #__internal_fall(value: number) {\n    let y1 = Math.round(1e6 * (this.falling.location[1] - value)) / 1e6,\n      y2 = this.falling.location[1] - 1;\n\n    if (y1 % 1 === 0) y1 -= 1e-6;\n    if (y2 % 1 === 0) y2 += 2e-6;\n\n    if (\n      !legal(this.falling.absoluteAt({ y: y1 }), this.board.state) ||\n      !legal(this.falling.absoluteAt({ y: y2 }), this.board.state)\n    )\n      return false;\n\n    const { highestY } = this.falling;\n    if (highestY > y1) this.falling.highestY = Math.floor(y1);\n    this.falling.location[1] = y1;\n    if (this.gameOptions.spinBonuses !== \"stupid\") this.lastSpin = null;\n    this.state &= ~constants.flags.STATE_FLOOR;\n\n    if (y1 < highestY || this.misc.movement.infinite) {\n      this.falling.lockResets = 0;\n      this.falling.rotResets = 0;\n    }\n\n    return true;\n  }\n\n  // @ts-expect-error unused\n  #__internal_lockout() {\n    // TODO: implement\n    // if (this.options.nolockout) return;\n    // if (!e || false === this.options.clutch)\n    //   return this.self.stm.LoseStockOrGameOver(\n    //     this.options.topoutisclear ? \"topout_clear\" : \"topout\",\n    //   );\n  }\n\n  #__internal_dcd() {\n    if (!this.#hasHitWall() || !this.handling.dcd) return;\n\n    this.input.lShift.das = Math.min(\n      this.input.lShift.das,\n      this.handling.das - this.handling.dcd\n    );\n    this.input.lShift.arr = this.handling.arr;\n\n    this.input.rShift.das = Math.min(\n      this.input.rShift.das,\n      this.handling.das - this.handling.dcd\n    );\n    this.input.rShift.arr = this.handling.arr;\n  }\n\n  #fall(subframe = 1 - this.subframe) {\n    if (this.falling.safeLock > 0) this.falling.safeLock--;\n    // TODO: if pause, return: if ((this.piece.safelock > 0 && this.piece.safelock--, this.S.pause)) return;\n\n    if (this.#isSleep()) return;\n\n    let fall = this.#getEffectiveGravity() * subframe;\n\n    if (this.glock > 0) this.glock -= subframe;\n    if (this.glock < 0) this.glock = 0;\n\n    if (this.input.keys.softDrop) {\n      if (this.handling.sdf === 41) fall = 400 * subframe;\n      else {\n        fall *= this.handling.sdf;\n\n        fall = Math.max(fall, 0.05 * this.handling.sdf);\n      }\n    }\n\n    if (\n      this.#shouldLock() &&\n      !legal(\n        this.falling.absoluteAt({ y: this.falling.location[1] - 1 }),\n        this.board.state\n      )\n    ) {\n      fall = 20;\n      this.state |= constants.flags.ACTION_FORCELOCK;\n    }\n\n    if (this.#shouldFallFaster()) {\n      fall +=\n        0.5 *\n        subframe *\n        (this.falling.rotResets - (this.misc.movement.lockResets + 15));\n    }\n\n    for (\n      let dropFactor = fall;\n      dropFactor > 0;\n      dropFactor -= Math.min(1, dropFactor)\n    ) {\n      const y = this.falling.location[1];\n\n      if (!this.#__internal_fall(Math.min(1, dropFactor))) {\n        if (this.#__internal_lock(subframe)) {\n          if (this.handling.safelock) this.falling.safeLock = 7;\n          this.#lock(false);\n        }\n        return;\n      }\n\n      if (Math.floor(y) !== Math.floor(this.falling.location[1])) {\n        this.state &= ~constants.flags.ROTATION_ALL;\n      }\n    }\n  }\n\n  #clampRotation(amount: number): Rotation {\n    return ((((this.falling.rotation + amount) % 4) + 4) % 4) as Rotation;\n  }\n\n  #__internal_rotate(\n    newX: number,\n    newY: number,\n    newRotation: number,\n    rotationDirection: number,\n    kick: ReturnType<typeof performKick>,\n    _isIRS = false\n  ) {\n    // Handle rotation flags based on direction\n    if (rotationDirection >= 2) {\n      // 180 degree rotation\n      rotationDirection = newRotation > this.falling.rotation ? 1 : -1;\n      this.state |= constants.flags.ROTATION_180;\n    }\n\n    // Update this.falling properties\n    this.falling.x = newX;\n    this.falling.y = newY;\n    this.falling.rotation = newRotation;\n\n    // Set rotation direction flags\n    this.state |=\n      rotationDirection === 1\n        ? constants.flags.ROTATION_RIGHT\n        : constants.flags.ROTATION_LEFT;\n    this.state &= ~(\n      constants.flags.ROTATION_SPIN |\n      constants.flags.ROTATION_MINI |\n      constants.flags.ROTATION_SPIN_ALL\n    );\n\n    // Update lock and rotation resets with caps\n    if (this.falling.lockResets < 31) this.falling.lockResets++;\n    if (this.falling.rotResets < 63) this.falling.rotResets++;\n\n    // Check for T-Spin\n    const spin = this.#detectSpin(this.#isTSpinKick(kick));\n\n    this.lastSpin = {\n      piece: this.falling.symbol,\n      type: spin\n    };\n\n    if (spin) {\n      this.state |= constants.flags.ROTATION_SPIN;\n      if (spin === \"mini\") {\n        this.state |= constants.flags.ROTATION_MINI;\n      }\n    }\n\n    this.falling.totalRotations++;\n\n    // Handle post-rotation actions\n    this.#__internal_dcd();\n\n    // Reset locking if not going to lock\n    if (!this.#shouldLock()) {\n      this.falling.locking = 0;\n    }\n\n    return true as const;\n  }\n\n  #kick(to: Rotation): false | Exclude<ReturnType<typeof performKick>, true> {\n    const kick = performKick(\n      this.kickTableName,\n      this.falling.symbol,\n      this.falling.location,\n      [this.falling.aox, this.falling.aoy],\n      !this.misc.movement.infinite &&\n        this.falling.totalRotations > this.misc.movement.lockResets + 15,\n      this.falling.states[to],\n      this.falling.rotation,\n      to,\n      this.board.state\n    );\n\n    if (typeof kick === \"object\") return kick;\n    else\n      return kick === false\n        ? false\n        : {\n            kick: [0, 0],\n            newLocation: [this.falling.location[0], this.falling.location[1]],\n            id: \"00\",\n            index: 0\n          };\n  }\n\n  #rotate(amount: number, isIRS = false) {\n    if (this.#isSleep()) {\n      if (this.handling.irs === \"tap\")\n        this.falling.irs = (((this.falling.irs + amount) % 4) + 4) % 4;\n      return false;\n    }\n\n    const to = this.#clampRotation(amount);\n\n    this.state |= constants.flags.ACTION_MOVE;\n    this.state |= constants.flags.ACTION_ROTATE;\n    const kick = this.#kick(to);\n\n    return kick\n      ? this.#__internal_rotate(\n          kick.newLocation[0],\n          kick.newLocation[1],\n          to,\n          amount,\n          kick,\n          isIRS\n        )\n      : false;\n  }\n\n  nextPiece(ignoreBlockout = false, isHold = false) {\n    const newTetromino = this.queue.shift()!;\n\n    this.initiatePiece(newTetromino, ignoreBlockout, isHold);\n  }\n\n  initiatePiece(piece: Mino, ignoreBlockout = false, isHold = false) {\n    if (this.handling.irs === \"hold\" && this.falling) {\n      let rotationState = 0;\n\n      // Calculate rotation based on input\n      if (this.input.keys.rotateCCW) rotationState -= 1;\n      if (this.input.keys.rotateCW) rotationState += 1;\n      if (this.input.keys.rotate180) rotationState += 2;\n\n      // Ensure rotation state is in 0-3 range\n      this.falling.irs = ((rotationState % 4) + 4) % 4;\n    }\n\n    if (this.handling.ihs === \"hold\" && this.input.keys.hold && !isHold) {\n      this.state |= constants.flags.ACTION_IHS;\n    }\n\n    this.#__internal_dcd();\n\n    this.state &= ~(\n      constants.flags.ROTATION_ALL |\n      constants.flags.STATE_ALL |\n      constants.flags.ACTION_FORCELOCK |\n      constants.flags.ACTION_SOFTDROP |\n      constants.flags.ACTION_MOVE |\n      constants.flags.ACTION_ROTATE\n    );\n\n    this.input.firstInputTime = -1;\n\n    if (!isHold) this.holdLocked = false;\n\n    this.falling = new Tetromino({\n      boardHeight: this.board.height,\n      boardWidth: this.board.width,\n      initialRotation:\n        this.kickTable.spawn_rotation[\n          piece.toLowerCase() as keyof typeof this.kickTable.spawn_rotation\n        ] ?? 0,\n      symbol: piece,\n      from: this.falling\n    });\n\n    if (!ignoreBlockout && this.#considerBlockout(isHold)) {\n      // Lose Stock or Game Over\n      this.state ^= constants.flags.ACTION_IHS;\n      this.falling.irs = 0;\n    } else {\n      if (this.state & constants.flags.ACTION_IHS) {\n        this.state ^= constants.flags.ACTION_IHS;\n        this.hold(true, ignoreBlockout);\n      } else {\n        if (this.falling.irs !== 0) {\n          this.#rotate(this.falling.irs, true);\n          this.falling.irs = 0;\n        }\n\n        if (this.#considerBlockout(!ignoreBlockout || isHold)) {\n          // lose stock or game over\n        } else {\n          if (this.#is20G()) {\n            this.#slamToFloor();\n          }\n        }\n      }\n    }\n  }\n\n  #considerBlockout(isSilent: boolean = false) {\n    if (legal(this.falling.absoluteBlocks, this.board.state)) {\n      // TODO: clutch count\n      // if (!isSilent) {\n      //   this.S.clutchCount = 0;\n      // }\n      return false;\n    }\n\n    let clutched = false;\n\n    if (this.lastWasClear && this.gameOptions.clutch !== false) {\n      const originalY = this.falling.location[1];\n      const originalHy = this.falling.highestY;\n\n      while (this.falling.y < this.board.fullHeight) {\n        this.falling.location[1]++;\n        this.falling.highestY++;\n\n        if (legal(this.falling.absoluteBlocks, this.board.state)) {\n          clutched = true;\n          break;\n        }\n      }\n\n      if (!clutched) {\n        this.falling.location[1] = originalY;\n        this.falling.highestY = originalHy;\n      }\n    }\n\n    if (!clutched) return true;\n\n    if (!isSilent) {\n      // TODO: update clutch count +1\n    }\n\n    return false;\n  }\n\n  hold(_ihs = false, ignoreBlockout = false) {\n    if (this.#isSleep()) {\n      if (this.handling.ihs === \"tap\") this.state |= constants.flags.ACTION_IHS;\n      return false;\n    }\n    if (this.holdLocked || !this.misc.allowed.hold) return false;\n    this.holdLocked = !this.misc.infiniteHold;\n    if (this.held) {\n      const save = this.held;\n      this.held = this.falling.symbol;\n      this.initiatePiece(save, ignoreBlockout, true);\n    } else {\n      this.held = this.falling.symbol;\n      this.nextPiece(ignoreBlockout, true);\n    }\n\n    this.holdLocked = !this.misc.infiniteHold;\n\n    return true;\n  }\n\n  #slamToFloor() {\n    while (this.#__internal_fall(1)) {}\n  }\n\n  get toppedOut() {\n    try {\n      for (const block of this.falling.blocks) {\n        if (\n          this.board.state[-block[1] + this.falling.y][\n            block[0] + this.falling.location[0]\n          ] !== null\n        )\n          return true;\n      }\n\n      return false;\n    } catch {\n      return true;\n    }\n  }\n\n  #isTSpinKick(kick: ReturnType<typeof Tetromino.prototype.rotate>) {\n    if (typeof kick === \"object\") {\n      return (\n        // fin cw and tst ccw\n        ((kick.id === \"23\" || kick.id === \"03\") &&\n          kick.kick[0] === 1 &&\n          kick.kick[1] === -2) ||\n        // fin ccw and tst cw\n        ((kick.id === \"21\" || kick.id === \"01\") &&\n          kick.kick[0] === -1 &&\n          kick.kick[1] === -2)\n      );\n    }\n\n    return false;\n  }\n\n  rotateCW() {\n    return this.#processRotate(1);\n  }\n\n  rotateCCW() {\n    return this.#processRotate(-1);\n  }\n\n  rotate180() {\n    return this.#processRotate(2);\n  }\n\n  moveRight() {\n    const res = this.falling.moveRight(this.board.state);\n    if (res && this.gameOptions.spinBonuses !== \"stupid\") this.lastSpin = null;\n    return res;\n  }\n\n  moveLeft() {\n    const res = this.falling.moveLeft(this.board.state);\n    if (res && this.gameOptions.spinBonuses !== \"stupid\") this.lastSpin = null;\n    return res;\n  }\n\n  dasRight() {\n    const res = this.falling.dasRight(this.board.state);\n    if (res && this.gameOptions.spinBonuses !== \"stupid\") this.lastSpin = null;\n    return res;\n  }\n\n  dasLeft() {\n    const res = this.falling.dasLeft(this.board.state);\n    if (res && this.gameOptions.spinBonuses !== \"stupid\") this.lastSpin = null;\n    return res;\n  }\n\n  softDrop() {\n    const res = this.falling.softDrop(this.board.state);\n    if (res && this.gameOptions.spinBonuses !== \"stupid\") this.lastSpin = null;\n    return res;\n  }\n\n  #maxSpin(...spins: SpinType[]) {\n    const score = (spin: SpinType) => [\"none\", \"mini\", \"normal\"].indexOf(spin);\n    return spins.reduce((a, b) => {\n      return score(a) > score(b) ? a : b;\n    });\n  }\n\n  #detectSpin(finOrTst: boolean): SpinType {\n    if (this.gameOptions.spinBonuses === \"none\") return \"none\";\n    const tSpin =\n      (\n        [\n          \"all\",\n          \"all-mini\",\n          \"all-mini+\",\n          \"all+\",\n          \"T-spins\",\n          \"T-spins+\"\n        ] as Game.SpinBonuses[]\n      ).includes(this.gameOptions.spinBonuses) && this.falling.symbol === \"t\"\n        ? this.#detectSpinFromCorners(finOrTst)\n        : false;\n    const allSpin = this.falling.isAllSpinPosition(this.board.state);\n\n    switch (this.gameOptions.spinBonuses) {\n      case \"stupid\":\n        return this.falling.isStupidSpinPosition(this.board.state)\n          ? \"normal\"\n          : \"none\";\n      case \"T-spins\":\n        return tSpin || \"none\";\n      case \"T-spins+\":\n        return this.#maxSpin(\n          tSpin || \"none\",\n          allSpin ? (this.falling.symbol === \"t\" ? \"mini\" : \"none\") : \"none\"\n        );\n      case \"all\":\n        return tSpin || (allSpin ? \"normal\" : \"none\");\n      case \"all-mini\":\n        return tSpin || (allSpin ? \"mini\" : \"none\");\n      case \"all+\":\n        return this.#maxSpin(\n          tSpin || \"none\",\n          allSpin ? (this.falling.symbol === \"t\" ? \"mini\" : \"normal\") : \"none\"\n        );\n      case \"all-mini+\":\n        return this.#maxSpin(tSpin || \"none\", allSpin ? \"mini\" : \"none\");\n      case \"mini-only\":\n        return tSpin === \"normal\"\n          ? \"mini\"\n          : this.#maxSpin(tSpin || \"none\", allSpin ? \"mini\" : \"none\");\n      case \"handheld\":\n        return this.#detectSpinFromCorners(finOrTst);\n    }\n  }\n\n  #spinbonuses(piece: Mino) {\n    const p = tetrominoes[piece];\n    const rules =\n      spinbonusRules[\n        this.gameOptions.spinBonuses as keyof typeof spinbonusRules\n      ];\n    // @ts-expect-error\n    return p?.spinbonus_override\n      ? // @ts-expect-error\n        p.spinbonus_override?.mini\n      : // @ts-expect-error\n        !!rules?.types_mini?.includes(piece);\n  }\n\n  #detectSpinFromCorners(finOrTst: boolean): SpinType {\n    if (\n      legal(\n        this.falling.blocks.map((block) => [\n          block[0] + this.falling.location[0],\n          -block[1] + this.falling.y - 1\n        ]),\n        this.board.state\n      )\n    )\n      return \"none\";\n\n    let corners = 0;\n    let frontCorners = 0;\n\n    for (let i = 0; i < 4; i++) {\n      const table =\n        cornerTable[this.falling.symbol as keyof typeof cornerTable]?.[\n          this.falling.rotation\n        ];\n      if (!table) break;\n\n      if (\n        this.board.occupied(\n          this.falling.x + table[i][0] + 1,\n          this.falling.y - table[i][1] - 1\n        )\n      ) {\n        corners++;\n        if (\n          this.falling.rotation === table[i][2] ||\n          this.falling.rotation === table[i][3]\n        ) {\n          frontCorners++;\n        }\n      }\n    }\n\n    if (corners < 3) return \"none\";\n\n    let spin: SpinType = \"normal\";\n    if (this.#spinbonuses(this.falling.symbol) && frontCorners !== 2)\n      spin = \"mini\";\n    if (finOrTst) spin = \"normal\";\n\n    return spin;\n  }\n\n  /** */\n  hardDrop() {\n    while (this.#__internal_fall(1));\n\n    return this.#lock(true);\n  }\n\n  #lock(hard: boolean): LockRes {\n    this.holdLocked = false;\n\n    // TODO: ARE (line clear, garbage)\n\n    const placed = this.falling.blocks.map(\n      (block) =>\n        [\n          this.falling.symbol,\n          this.falling.location[0] + block[0],\n          this.falling.y - block[1]\n        ] as [Mino, number, number]\n    );\n\n    this.board.add(...placed);\n    this.connectedBoard.add(\n      ...this.connect(placed.map(([_, x, y]) => [x, -y])).map(\n        ([x, y, s]) =>\n          [{ mino: this.falling.symbol, connection: s }, x, -y] as [\n            { mino: Mino; connection: number },\n            number,\n            number\n          ]\n      )\n    );\n\n    this.connectedBoard.clearBombsAndLines(placed.map((b) => [b[1], b[2]]));\n    const { lines, garbageCleared } = this.board.clearBombsAndLines(\n      placed.map((b) => [b[1], b[2]])\n    );\n    const pc = this.board.perfectClear;\n\n    this.stats.garbage.cleared += garbageCleared;\n\n    let brokeB2B: false | number = this.stats.b2b;\n    if (lines > 0) {\n      this.stats.combo++;\n      if (\n        ((this.lastSpin && this.lastSpin.type !== \"none\") || lines >= 4) &&\n        !(pc && this.pc && this.pc.b2b)\n      ) {\n        this.stats.b2b++;\n        brokeB2B = false;\n      }\n      if (pc && this.pc && this.pc.b2b) {\n        this.stats.b2b += this.pc.b2b;\n        brokeB2B = false;\n      }\n\n      if (brokeB2B !== false) {\n        this.stats.b2b = -1;\n      }\n    } else {\n      this.stats.combo = -1;\n      brokeB2B = false;\n    }\n\n    const gSpecialBonus =\n      this.garbageQueue.options.specialBonus &&\n      garbageCleared > 0 &&\n      ((this.lastSpin && this.lastSpin.type !== \"none\") || lines >= 4)\n        ? 1\n        : 0;\n\n    const garbage = garbageCalcV2(\n      {\n        b2b: Math.max(this.stats.b2b, 0),\n        combo: Math.max(this.stats.combo, 0),\n        enemies: 0,\n        lines,\n        piece: this.falling.symbol,\n        spin: this.lastSpin ? this.lastSpin.type : \"none\"\n      },\n      {\n        ...this.gameOptions,\n        b2b: { chaining: this.b2b.chaining, charging: !!this.b2b.charging }\n      }\n    );\n\n    const gEvents =\n      garbage.garbage > 0 || gSpecialBonus > 0\n        ? [\n            this.garbageQueue.round(\n              garbage.garbage * this.dynamic.garbageMultiplier.get() +\n                gSpecialBonus\n            )\n          ]\n        : [];\n\n    let surged = 0;\n\n    if (brokeB2B !== false) {\n      let btb = brokeB2B;\n      if (this.b2b.charging !== false && btb + 1 > this.b2b.charging.at) {\n        surged = Math.floor(\n          (btb - this.b2b.charging.at + this.b2b.charging.base + 1) *\n            this.dynamic.garbageMultiplier.get()\n        );\n\n        const garbages = [\n          Math.round(surged / 3),\n          Math.round(surged / 3),\n          surged - 2 * Math.round(surged / 3)\n        ];\n        gEvents.splice(0, 0, ...garbages);\n        brokeB2B = false;\n      }\n    }\n    if (pc && this.pc) {\n      gEvents.push(\n        this.garbageQueue.round(\n          this.pc.garbage * this.dynamic.garbageMultiplier.get()\n        )\n      );\n    }\n\n    const res: LockRes = {\n      mino: this.falling.symbol,\n      garbageCleared,\n      lines,\n      spin: this.lastSpin ? this.lastSpin.type : \"none\",\n      garbage: gEvents.filter((g) => g > 0),\n      rawGarbage: gEvents.filter((g) => g > 0),\n      surge: surged,\n      stats: this.stats,\n      garbageAdded: false,\n      topout: false,\n      keysPresses: this.resCache.keys.splice(0),\n      pieceTime:\n        Math.round((this.frame + this.subframe - this.resCache.lastLock) * 10) /\n        10\n    };\n\n    for (const gb of res.garbage) this.stats.garbage.attack += gb;\n\n    if (lines > 0) {\n      const cancelEvents: Events[\"garbage.cancel\"][] = [];\n      this.lastWasClear = true;\n      while (res.garbage.length > 0) {\n        if (res.garbage[0] === 0) {\n          res.garbage.shift();\n          continue;\n        }\n        const [r, cancelled] = this.garbageQueue.cancel(\n          res.garbage[0],\n          this.stats.pieces,\n          {\n            openerPhase: (this.misc.date ?? new Date()) < new Date(2025, 1, 16)\n          }\n        );\n        cancelEvents.push(\n          ...cancelled.map((c) => ({\n            iid: c.cid,\n            amount: c.amount,\n            size: c.size\n          }))\n        );\n\n        if (r === 0) res.garbage.shift();\n        else {\n          res.garbage[0] = r;\n          break;\n        }\n      }\n\n      cancelEvents.forEach((event) => {\n        this.events.emit(\"garbage.cancel\", event);\n      });\n    } else {\n      this.lastWasClear = false;\n      const garbages = this.garbageQueue.tank(\n        this.frame,\n        this.dynamic.garbageCap.get(),\n        hard\n      );\n      res.garbageAdded = garbages;\n\n      if (res.garbageAdded) {\n        const tankEvent: Events[\"garbage.tank\"][] = [];\n        garbages.forEach((garbage, idx) => {\n          this.board.insertGarbage({\n            ...garbage,\n            bombs: this.garbageQueue.options.bombs\n          });\n          this.connectedBoard.insertGarbage({\n            ...garbage,\n            bombs: this.garbageQueue.options.bombs,\n            isBeginning: idx === 0 || garbages[idx - 1].id !== garbage.id,\n            isEnd:\n              idx === garbages.length - 1 || garbages[idx + 1].id !== garbage.id\n          });\n\n          if (\n            tankEvent.length === 0 ||\n            tankEvent[tankEvent.length - 1].iid !== garbage.id\n          ) {\n            tankEvent.push({\n              iid: garbage.id,\n              column: garbage.column,\n              amount: garbage.amount,\n              size: garbage.size\n            });\n          } else {\n            tankEvent[tankEvent.length - 1].amount += garbage.amount;\n          }\n        });\n\n        tankEvent.forEach((event) => {\n          this.events.emit(\"garbage.tank\", event);\n        });\n      }\n    }\n\n    this.nextPiece();\n\n    this.lastSpin = null;\n\n    try {\n      if (!legal(this.falling.absoluteBlocks, this.board.state))\n        res.topout = true;\n    } catch {\n      res.topout = true;\n    }\n\n    if (res.garbage.length > 0)\n      if (this.multiplayer)\n        this.multiplayer.targets.forEach((target) =>\n          res.garbage.forEach((g) =>\n            this.igeHandler.send({ amount: g, playerID: target })\n          )\n        );\n\n    const sent = res.garbage.reduce((a, b) => a + b, 0);\n    this.stats.garbage.sent += sent;\n\n    if (this.stats.combo >= 0) this.currentSpike += sent;\n    else this.currentSpike = 0;\n\n    this.resCache.pieces++;\n    this.resCache.garbage.sent.push(...res.garbage);\n    this.resCache.garbage.received.push(...(res.garbageAdded || []));\n    this.resCache.lastLock = this.frame + this.subframe;\n\n    this.stats.pieces++;\n    this.stats.lines += lines;\n\n    this.events.emit(\"falling.lock\", deepCopy(res));\n\n    return res;\n  }\n\n  press<T extends Game.Key | \"dasLeft\" | \"dasRight\">(key: T) {\n    if (key in this) return this[key]();\n    else throw new Error(\"invalid key: \" + key);\n  }\n\n  #keydown({ data: event }: Game.Replay.Frames.Keypress) {\n    this.#processSubframe(event.subframe);\n    this.resCache.keys.push(event.key);\n    // TODO: inversion?\n    // if (this.misc.inverted)\n    //   switch (e.key) {\n    //     case \"moveLeft\":\n    //       e.key = \"moveRight\";\n    //       break;\n    //     case \"moveRight\":\n    //       e.key = \"moveLeft\";\n    //   }\n\n    switch (event.key) {\n      case \"moveLeft\":\n        this.falling.keys++;\n        if (this.input.firstInputTime == -1)\n          this.input.firstInputTime = this.frame + this.subframe;\n        this.#activateShift(\"lShift\", !!event.hoisted);\n        this.#__internal_shift();\n        return;\n\n      case \"moveRight\":\n        this.falling.keys++;\n        if (this.input.firstInputTime == -1)\n          this.input.firstInputTime = this.frame + this.subframe;\n        this.#activateShift(\"rShift\", !!event.hoisted);\n        this.#__internal_shift();\n        return;\n\n      case \"softDrop\":\n        this.input.keys.softDrop = true;\n        if (this.input.firstInputTime == -1)\n          this.input.firstInputTime = this.frame + this.subframe;\n        return;\n\n      case \"rotateCCW\":\n        this.input.keys.rotateCCW = true;\n        break;\n\n      case \"rotateCW\":\n        this.input.keys.rotateCW = true;\n        break;\n\n      case \"rotate180\":\n        this.input.keys.rotate180 = true;\n        break;\n      case \"hold\":\n        this.input.keys.hold = true;\n        break;\n    }\n\n    // todo: all in if (!this.pause)\n    switch (event.key) {\n      case \"rotateCCW\":\n        if (this.input.firstInputTime == -1)\n          this.input.firstInputTime = this.frame + this.subframe;\n        this.#processRotate(-1);\n        break;\n\n      case \"rotateCW\":\n        if (this.input.firstInputTime == -1)\n          this.input.firstInputTime = this.frame + this.subframe;\n        this.#processRotate(1);\n        break;\n\n      case \"rotate180\":\n        if (!this.misc.allowed.spin180) return;\n        if (this.input.firstInputTime == -1)\n          this.input.firstInputTime = this.frame + this.subframe;\n        this.#processRotate(2);\n        break;\n\n      case \"hardDrop\":\n        if (this.misc.allowed.hardDrop === false || this.falling.safeLock !== 0)\n          return;\n        this.hardDrop();\n        return;\n\n      case \"hold\":\n        this.hold();\n        return;\n    }\n  }\n\n  #keyup({ data: event }: Game.Replay.Frames.Keypress) {\n    this.#processSubframe(event.subframe);\n    // TODO: inversion?\n    // if (this.misc.inverted)\n    //   switch (e.key) {\n    //     case \"moveLeft\":\n    //       e.key = \"moveRight\";\n    //       break;\n    //     case \"moveRight\":\n    //       e.key = \"moveLeft\";\n    //   }\n\n    switch (event.key) {\n      case \"moveLeft\":\n        this.input.lShift.held = false;\n        this.input.lShift.das = 0;\n        this.input.lastShift = this.input.rShift.held\n          ? this.input.rShift.dir\n          : this.input.lastShift;\n        if (this.handling.cancel) {\n          this.input.rShift.arr = this.handling.arr;\n          this.input.rShift.das = 0;\n        }\n        break;\n\n      case \"moveRight\":\n        this.input.rShift.held = false;\n        this.input.rShift.das = 0;\n        this.input.lastShift = this.input.lShift.held\n          ? this.input.lShift.dir\n          : this.input.lastShift;\n        if (this.handling.cancel) {\n          this.input.lShift.arr = this.handling.arr;\n          this.input.lShift.das = 0;\n        }\n        break;\n\n      case \"softDrop\":\n        this.state |= constants.flags.ACTION_SOFTDROP;\n        this.input.keys.softDrop = false;\n        break;\n\n      case \"rotateCCW\":\n        this.input.keys.rotateCCW = false;\n        break;\n\n      case \"rotateCW\":\n        this.input.keys.rotateCW = false;\n        break;\n\n      case \"rotate180\":\n        this.input.keys.rotate180 = false;\n        break;\n\n      case \"hold\":\n        this.input.keys.hold = false;\n        break;\n    }\n  }\n\n  #activateShift(shift: \"lShift\" | \"rShift\", hoisted: boolean) {\n    this.input[shift].held = true;\n    this.input[shift].das = hoisted ? this.handling.das - this.handling.dcd : 0;\n    this.input[shift].arr = this.handling.arr;\n    this.input.lastShift = this.input[shift].dir;\n  }\n\n  #processRotate(rotation: number) {\n    this.falling.keys += rotation >= 2 ? 2 : 1;\n    return this.#rotate(rotation as Rotation);\n  }\n\n  #processSubframe(subframe: number) {\n    if (subframe <= this.subframe) return;\n    const delta = subframe - this.subframe;\n    this.#processAllShift(delta);\n    this.#fall(delta);\n    this.subframe = subframe;\n  }\n\n  #__internal_shift() {\n    if (!this.#isSleep()) {\n      // TODO: missing: && !this.pause\n      this.state |= constants.flags.ACTION_MOVE;\n      if (\n        legal(\n          this.falling.absoluteAt({\n            x: this.falling.location[0] + this.input.lastShift\n          }),\n          this.board.state\n        )\n      ) {\n        this.falling.location[0] += this.input.lastShift;\n        if (this.falling.lockResets < 31) this.falling.lockResets++;\n        this.#clearFlags(\n          constants.flags.ROTATION_ALL | constants.flags.STATE_WALL\n        );\n        // fallingdirty = true;\n        if (this.#is20G()) this.#slamToFloor();\n        if (!this.#shouldLock()) this.falling.locking = 0;\n        return true;\n      } else {\n        this.state |= constants.flags.STATE_WALL;\n        return false;\n      }\n    }\n  }\n\n  #processShift(shift: \"lShift\" | \"rShift\", delta: number) {\n    if (\n      !this.input[shift].held ||\n      this.input.lastShift !== this.input[shift].dir\n    )\n      return;\n    const arrDelta = Math.max(\n      0,\n      delta - Math.max(0, this.handling.das - this.input[shift].das)\n    );\n    this.input[shift].das = Math.min(\n      this.input[shift].das + delta,\n      this.handling.das\n    );\n    if (this.input[shift].das < this.handling.das) return;\n    if (this.#isSleep()) return; // TODO: missing: && !this.pause\n    this.input[shift].arr += arrDelta;\n    if (this.input[shift].arr < this.handling.arr) return;\n    const arrMultiplier =\n      this.handling.arr === 0\n        ? this.board.width\n        : Math.floor(this.input[shift].arr / this.handling.arr);\n    this.input[shift].arr -= this.handling.arr * arrMultiplier;\n    for (let i = 0; i < arrMultiplier; i++) this.#__internal_shift();\n  }\n\n  #processAllShift(subFrameDiff = 1 - this.subframe) {\n    for (const shift of [\"lShift\", \"rShift\"] as const)\n      this.#processShift(shift, subFrameDiff);\n  }\n\n  #run(...frames: Game.Replay.Frame[]) {\n    frames.forEach((frame) => {\n      switch (frame.type) {\n        case \"keydown\":\n          this.#keydown(frame);\n          break;\n        case \"keyup\":\n          this.#keyup(frame);\n          break;\n        case \"ige\":\n          if (frame.data.type === \"interaction\") {\n            if (frame.data.data.type === \"garbage\") {\n              const original = frame.data.data.amt;\n              const amount = this.multiplayer?.passthrough?.network\n                ? this.igeHandler.receive({\n                    playerID: frame.data.data.gameid,\n                    ackiid: frame.data.data.ackiid,\n                    amount: frame.data.data.amt,\n                    iid: frame.data.data.iid\n                  })\n                : frame.data.data.amt;\n              this.receiveGarbage({\n                frame:\n                  Number.MAX_SAFE_INTEGER -\n                  this.garbageQueue.options.garbage.speed,\n                amount,\n                size: frame.data.data.size,\n                cid: frame.data.data.iid,\n                gameid: frame.data.data.gameid,\n                confirmed: false\n              });\n              this.stats.garbage.receive += amount;\n              this.events.emit(\"garbage.receive\", {\n                iid: frame.data.data.iid,\n                amount,\n                originalAmount: original\n              });\n            }\n          } else if (frame.data.type === \"interaction_confirm\") {\n            if (frame.data.data.type === \"garbage\") {\n              this.garbageQueue.confirm(\n                frame.data.data.iid,\n                frame.data.data.gameid,\n                frame.frame\n              );\n\n              this.events.emit(\"garbage.confirm\", {\n                iid: frame.data.data.iid,\n                gameid: frame.data.data.gameid,\n                frame: frame.frame\n              });\n            }\n          } else if (frame.data.type === \"target\" && this.multiplayer) {\n            this.multiplayer.targets = frame.data.data.targets;\n          }\n          break;\n      }\n    });\n  }\n\n  tick(frames: Game.Replay.Frame[]) {\n    this.subframe = 0;\n\n    this.#run(...frames);\n\n    this.frame++;\n    this.#processAllShift();\n    this.#fall();\n    // TODO: execute waiting frames\n    // TODO: process garbage are\n    Object.keys(this.dynamic).forEach((key) =>\n      this.dynamic[key as keyof typeof this.dynamic].tick()\n    );\n\n    return { ...this.flushRes() };\n  }\n\n  receiveGarbage(...garbage: IncomingGarbage[]) {\n    this.garbageQueue.receive(...garbage);\n  }\n\n  getPreview(piece: Mino) {\n    return tetrominoes[piece.toLowerCase()].preview;\n  }\n\n  connect(blocks: [x: number, y: number][]) {\n    const exists = (x: number, y: number) =>\n      !!blocks.find(([a, b]) => a === x && y === b);\n\n    return blocks.map(([x, y]) => {\n      let state = 0;\n      if (!exists(x, y - 1)) state |= 0b1000;\n      if (!exists(x + 1, y)) state |= 0b0100;\n      if (!exists(x, y + 1)) state |= 0b0010;\n      if (!exists(x - 1, y)) state |= 0b0001;\n      if (\n        (state === 0b1001 && !exists(x + 1, y + 1)) ||\n        (state === 0b1100 && !exists(x - 1, y + 1)) ||\n        (state === 0b0011 && !exists(x + 1, y - 1)) ||\n        (state === 0b0110 && !exists(x - 1, y - 1)) ||\n        (state === 0b0010 && !exists(x + 1, y - 1) && !exists(x - 1, y - 1)) ||\n        (state === 0b0001 && !exists(x + 1, y - 1) && !exists(x + 1, y + 1)) ||\n        (state === 0b1000 && !exists(x - 1, y + 1) && !exists(x + 1, y + 1)) ||\n        (state === 0b0100 && !exists(x - 1, y - 1) && !exists(x - 1, y + 1))\n      ) {\n        state |= 0b1_0000;\n      }\n\n      return [x, y, state] as const;\n    });\n  }\n\n  getConnectedPreview(piece: Mino) {\n    const data = tetrominoes[piece.toLowerCase()].preview;\n\n    return {\n      ...data,\n      data: this.connect(data.data as any[])\n    };\n  }\n\n  /** @deprecated Engine.onQueuePieces is deprecated and no longer functional. Switch to Engine.events.on(\"queue.add\", (pieces) => {}) instead. */\n  onQueuePieces(_listener: (pieces: Mino[]) => void) {\n    console.log(\n      `${chalk.redBright(\"[Triangle.js]\")} Engine.onQueuePieces is deprecated and no longer functional. Switch to Engine.events.on(\"queue.add\", (pieces) => {}) instead.`\n    );\n  }\n\n  private static colorMap = {\n    i: chalk.bgCyan,\n    j: chalk.bgBlue,\n    l: chalk.bgYellow,\n    o: chalk.bgWhite,\n    s: chalk.bgGreenBright,\n    t: chalk.bgMagentaBright,\n    z: chalk.bgRedBright,\n    gb: chalk.bgBlackBright,\n    bomb: chalk.bgHex(\"#FFA500\")\n  };\n\n  get text() {\n    const boardTop = this.board.state.findIndex((row: (string | null)[]) =>\n      row.every((block) => block === null)\n    );\n    const height = Math.max(this.garbageQueue.size, boardTop, 0);\n\n    const output: string[] = [];\n    for (let i = 0; i < height; i++) {\n      let str = i % 2 === 0 ? \"|\" : \" \";\n      if (i < this.garbageQueue.size) str += \" \" + chalk.bgRed(\" \") + \" \";\n      else str += \"   \";\n      if (i > boardTop) {\n        output.push(\n          str + \"  \".repeat(this.board.width) + \" \" + (i % 2 === 0 ? \"|\" : \" \")\n        );\n        continue;\n      }\n\n      for (let j = 0; j < this.board.width; j++) {\n        const block = this.board.state[i][j];\n        str += block ? Engine.colorMap[block](\"  \") : \"  \";\n      }\n\n      output.push(str + \" \" + (i % 2 === 0 ? \"|\" : \" \"));\n    }\n\n    return output.reverse().join(\"\\n\");\n  }\n\n  /** Return an engine with the same config. Does not preserve state. */\n  clone() {\n    return new Engine(this.initializer);\n  }\n}\n\nexport * from \"./queue\";\nexport * from \"./garbage\";\nexport * from \"./utils\";\nexport * from \"./board\";\nexport * from \"./types\";\nexport * from \"./multiplayer\";"],"names":["Engine","queue","held","holdLocked","falling","_kickTable","board","connectedBoard","lastSpin","lastWasClear","stats","gameOptions","garbageQueue","frame","subframe","initializer","handling","input","pc","b2b","dynamic","glock","multiplayer","igeHandler","misc","state","currentSpike","events","EventEmitter","resCache","options","deepCopy","type","Date","copy","d","init","Queue","onRepopulate","bind","kickTable","Board","ConnectedBoard","date","GarbageQueue","LegacyGarbageQueue","garbage","IGEHandler","opponents","targets","passthrough","network","includes","replay","travel","combo","pieces","lines","sent","attack","receive","cleared","chaining","charging","gravity","IncreaseTracker","value","increase","marginTime","garbageMultiplier","multiplier","garbageCap","cap","lShift","arr","das","dir","rShift","lastShift","firstInputTime","time","start","zero","locked","prev","frameoffset","lastPieceTime","keys","softDrop","hold","rotateCW","rotateCCW","rotate180","flushRes","nextPiece","bindAll","res","received","lastLock","reset","moveRight","moveLeft","dasRight","dasLeft","hardDrop","snapshot","fromSnapshot","emit","index","ige","Tetromino","boardHeight","height","boardWidth","width","initialRotation","spawn_rotation","symbol","toLowerCase","from","key","Object","i","shift","tick","kicks","kickTableName","dynamicStats","apm","pps","vs","surgePower","Math","floor","at","base","get","constants","flags","STATE_WALL","ROTATION_LEFT","ROTATION_RIGHT","ROTATION_180","ROTATION_SPIN","ROTATION_MINI","ROTATION_SPIN_ALL","STATE_SLEEP","STATE_FLOOR","STATE_NODRAW","ACTION_SOFTDROP","ACTION_FORCELOCK","is20G","mode20G","movement","may20G","preferSoftDrop","may20g","sdf","infinite","lockResets","rotResets","e","locking","lockTime","y1","round","location","y2","legal","absoluteAt","y","highestY","spinBonuses","dcd","min","safeLock","fall","max","dropFactor","safelock","ROTATION_ALL","amount","rotation","newX","newY","newRotation","rotationDirection","kick","_isIRS","x","spin","piece","totalRotations","to","performKick","aox","aoy","states","newLocation","id","isIRS","irs","ACTION_MOVE","ACTION_ROTATE","ignoreBlockout","isHold","newTetromino","initiatePiece","rotationState","ihs","ACTION_IHS","STATE_ALL","isSilent","absoluteBlocks","clutched","clutch","originalY","originalHy","fullHeight","_ihs","allowed","infiniteHold","save","toppedOut","block","blocks","spins","score","indexOf","reduce","a","b","finOrTst","tSpin","allSpin","isAllSpinPosition","isStupidSpinPosition","p","tetrominoes","rules","spinbonusRules","spinbonus_override","mini","types_mini","map","corners","frontCorners","table","cornerTable","occupied","hard","placed","add","connect","_","s","mino","connection","clearBombsAndLines","garbageCleared","perfectClear","brokeB2B","gSpecialBonus","specialBonus","garbageCalcV2","enemies","gEvents","surged","btb","garbages","splice","push","filter","g","rawGarbage","surge","garbageAdded","topout","keysPresses","pieceTime","gb","cancelEvents","length","r","cancelled","cancel","openerPhase","c","iid","cid","size","forEach","event","tank","tankEvent","idx","insertGarbage","bombs","isBeginning","isEnd","column","target","send","playerID","press","Error","data","hoisted","spin180","delta","arrDelta","arrMultiplier","subFrameDiff","frames","original","amt","gameid","ackiid","receiveGarbage","Number","MAX_SAFE_INTEGER","speed","confirmed","originalAmount","confirm","getPreview","preview","exists","find","getConnectedPreview","onQueuePieces","_listener","console","log","chalk","redBright","colorMap","bgCyan","j","bgBlue","l","bgYellow","o","bgWhite","bgGreenBright","t","bgMagentaBright","z","bgRedBright","bgBlackBright","bomb","bgHex","text","boardTop","findIndex","row","every","output","str","bgRed","repeat","reverse","join","clone"],"mappings":"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"}